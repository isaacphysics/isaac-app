APP_VERSION=$1
API_VERSION=`docker inspect -f '{{.Config.Labels.apiVersion}}' docker.isaacscience.org/isaac-app-$APP_VERSION`
ENV=$2

shift 2

API_NAME=api-$ENV-$API_VERSION
APP_NAME=app-$ENV-$APP_VERSION
MAYBE_EXTERNAL=external_
VERSION_FILE_PERMS=rw
CONTENT=tracking

if [ "$ENV" == "dev" ]; then
  ES=es-tracking
  PG=pg-dev
elif [ "$ENV" == "staging" ]; then
  ES=es-tracking
  PG=pg-staging
elif [ "$ENV" == "live" ]; then
  ES=es-live
  PG=pg-live
  CONTENT=live
elif [ "$ENV" == "test" ]; then
  ES=es-test
  PG=pg-test
  API_NAME=api-test
  APP_NAME=app-test
  MAYBE_EXTERNAL=
  CONTENT=live
  VERSION_FILE_PERMS=ro
  read -r -d '' TEST_DEPS << EOM
es-test:
    container_name: $ES
    restart: always
    image: elasticsearch:1.4
    volumes:                                                                                                                                
      - ../isaac-api/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
  pg-test:
    container_name: $PG
    restart: always
    image: isaac-pg
    volumes:
      - /local/data/test-db-schema.sql:/docker-entrypoint-initdb.d/test-db-schema.sql
EOM

else
  echo "Must set environment to dev, staging or live."
  exit 1
fi

docker pull docker.isaacscience.org/isaac-app-$APP_VERSION
docker pull docker.isaacscience.org/isaac-api-$API_VERSION

cat << EOF | docker-compose -p dc-$APP_NAME -f - $@
version: '2'
services:
  $TEST_DEPS
  $APP_NAME:
    container_name: $APP_NAME
    image: docker.isaacscience.org/isaac-app-$APP_VERSION
    restart: always
    networks:
      default:
        aliases:
          - app-$ENV
  $API_NAME:
    container_name: $API_NAME
    image: docker.isaacscience.org/isaac-api-$API_VERSION
    restart: always
    ${MAYBE_EXTERNAL}links:
      - $ES:elasticsearch
      - $PG:postgres
    volumes:
      - /local/data/m2:/root/.m2:rw
      - /local/data/conf/segue-config.$ENV.properties:/local/data/rutherford/conf/segue-config.properties:ro
      - /local/data/conf/live_version.$CONTENT.properties:/local/data/rutherford/conf/live_version.properties:$VERSION_FILE_PERMS
      - /local/data/rutherford-content:/local/data/rutherford/git-contentstore/rutherford-content:rw
      - /local/data/keys:/local/data/rutherford/keys:ro
      - /local/data/school_list_2016.csv:/local/data/rutherford/school_list_2016.csv:ro
    networks:
      default:
        aliases:
          - api-$ENV-any
    logging:
      driver: journald
      options:
        tag: isaac-api-$ENV
networks:
  default:
    external:
      name: isaac
EOF

exit 0
